<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Money Fest - Batches</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#667eea',
                            600: '#764ba2'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-gradient:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .progress-gradient {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl p-4 mb-4 shadow-lg flex flex-wrap justify-between items-center gap-3">
            <h1 class="text-xl font-bold text-gray-800">Batches</h1>
            <div class="flex flex-wrap gap-2 items-center">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="includeArchived" class="w-4 h-4 text-brand-500 bg-gray-100 border-gray-300 rounded focus:ring-brand-500">
                    <span class="text-sm text-gray-700">Show archived</span>
                </label>
                <button onclick="logout()" class="px-3 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                    Logout
                </button>
                <button onclick="window.location.href='/static/users.html'" class="px-3 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                    Users
                </button>
                <button onclick="window.location.href='/static/rules.html'" class="px-3 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                    Rules
                </button>
                <button data-modal-target="uploadModal" data-modal-toggle="uploadModal" class="px-4 py-2 text-sm font-semibold text-white btn-gradient rounded-lg transition-all">
                    Upload CSV
                </button>
            </div>
        </div>

        <!-- Batch List -->
        <div id="batchList" class="space-y-3">
            <div class="text-center py-12 text-white">Loading batches...</div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <div class="relative bg-white rounded-xl shadow-xl">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">Upload CSV</h3>
                    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-100 hover:text-gray-700 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="uploadModal">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <!-- Modal Body -->
                <form id="uploadForm" onsubmit="handleUpload(event)" class="p-4 space-y-4">
                    <div>
                        <label for="batchName" class="block text-sm font-semibold text-gray-700 mb-1">Batch Name</label>
                        <input type="text" id="batchName" name="batchName" required placeholder="e.g., November 2024"
                               class="w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:outline-none focus:border-brand-500 transition-colors">
                    </div>
                    <div>
                        <label for="csvFile" class="block text-sm font-semibold text-gray-700 mb-1">CSV File</label>
                        <input type="file" id="csvFile" name="csvFile" accept=".csv" required
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-brand-500 file:text-white hover:file:bg-brand-600 cursor-pointer">
                        <p class="text-xs text-gray-400 mt-1">Supports AceMoney (latin-1) and Danske Bank (UTF-8) formats</p>
                    </div>
                    <div id="uploadError" class="hidden p-3 bg-red-50 text-red-600 border border-red-200 rounded-lg text-sm"></div>
                    <div class="flex gap-2 justify-end pt-2">
                        <button type="button" data-modal-hide="uploadModal" class="px-4 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                            Cancel
                        </button>
                        <button type="submit" id="uploadButton" class="px-4 py-2 text-sm font-semibold text-white btn-gradient rounded-lg transition-all">
                            Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/toast.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
    <script>
        let includeArchived = false;
        let uploadModal = null;

        // Initialize modal after Flowbite loads
        window.addEventListener('DOMContentLoaded', () => {
            loadBatches();

            // Get modal instance
            const $targetEl = document.getElementById('uploadModal');
            uploadModal = new Modal($targetEl);

            // Handle archive checkbox
            document.getElementById('includeArchived').addEventListener('change', (e) => {
                includeArchived = e.target.checked;
                loadBatches();
            });
        });

        async function loadBatches() {
            try {
                const response = await fetch(`/batches?include_archived=${includeArchived}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/index.html';
                        return;
                    }
                    throw new Error('Failed to load batches');
                }

                const batches = await response.json();
                renderBatches(batches);
            } catch (error) {
                console.error('Error loading batches:', error);
                document.getElementById('batchList').innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center shadow-lg">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">Error loading batches</h2>
                        <p class="text-gray-500 text-sm">Please try refreshing the page</p>
                    </div>
                `;
            }
        }

        function renderBatches(batches) {
            const batchList = document.getElementById('batchList');

            if (batches.length === 0) {
                batchList.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center shadow-lg">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">No batches yet</h2>
                        <p class="text-gray-500 text-sm">Upload a CSV file to get started</p>
                    </div>
                `;
                return;
            }

            batchList.innerHTML = batches.map(batch => `
                <div class="bg-white rounded-xl p-4 shadow-lg cursor-pointer transition-all hover:shadow-xl hover:-translate-y-0.5 ${batch.status === 'archived' ? 'opacity-70' : ''}"
                     onclick="openBatch(${batch.id})">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-base font-semibold text-gray-800 mb-1">${escapeHtml(batch.name)}</div>
                            <div class="text-xs text-gray-500">${batch.date_range_start} to ${batch.date_range_end}</div>
                        </div>
                        <span class="px-2.5 py-1 text-xs font-semibold rounded-full ${batch.status === 'in_progress' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">
                            ${batch.status === 'in_progress' ? 'In Progress' : batch.status === 'complete' ? 'Complete' : 'Archived'}
                        </span>
                    </div>
                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>${batch.categorized_count}/${batch.total_count} categorized</span>
                            <span>${batch.progress_percent.toFixed(0)}%</span>
                        </div>
                        <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full progress-gradient transition-all" style="width: ${batch.progress_percent}%"></div>
                        </div>
                    </div>
                    <div class="flex gap-2" onclick="event.stopPropagation()">
                        ${batch.status === 'in_progress' ? `
                            <button onclick="archiveBatch(event, ${batch.id}, '${escapeHtml(batch.name)}')"
                                    class="px-2.5 py-1.5 text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                                Archive
                            </button>
                        ` : ''}
                        <button onclick="downloadBatch(event, ${batch.id}, '${escapeHtml(batch.name)}', '${batch.status}')"
                                class="px-2.5 py-1.5 text-xs font-semibold text-white btn-gradient rounded-lg transition-all">
                            Download
                        </button>
                        <button onclick="deleteBatch(event, ${batch.id}, '${escapeHtml(batch.name)}', ${batch.total_count})"
                                class="px-2.5 py-1.5 text-xs font-medium bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function openBatch(batchId) {
            window.location.href = `/static/categorize.html?batch=${batchId}`;
        }

        async function deleteBatch(event, batchId, batchName, totalCount) {
            event.stopPropagation();

            const message = `Delete batch "${batchName}"?\n\nThis will permanently delete all ${totalCount} transaction${totalCount !== 1 ? 's' : ''}.`;
            if (!confirm(message)) {
                return;
            }

            try {
                const response = await fetch(`/batches/${batchId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/index.html';
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete batch');
                }

                toast.success('Batch deleted successfully');
                loadBatches();
            } catch (error) {
                console.error('Delete error:', error);
                toast.error(error.message || 'Failed to delete batch');
            }
        }

        async function archiveBatch(event, batchId, batchName) {
            event.stopPropagation();

            const message = `Archive batch "${batchName}"?\n\nThis will mark the batch as complete and move it to archived batches.`;
            if (!confirm(message)) {
                return;
            }

            try {
                const response = await fetch(`/batches/${batchId}/archive`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/index.html';
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to archive batch');
                }

                toast.success('Batch archived successfully');
                loadBatches();
            } catch (error) {
                console.error('Archive error:', error);
                toast.error(error.message || 'Failed to archive batch');
            }
        }

        async function downloadBatch(event, batchId, batchName, batchStatus) {
            event.stopPropagation();

            if (batchStatus === 'in_progress') {
                const confirmed = confirm(
                    `Download "${batchName}" while still in progress?\n\n` +
                    `This batch is not complete. You can download it now but it will NOT be archived.\n` +
                    `You can continue categorizing and download again later.`
                );
                if (!confirmed) return;
            }

            try {
                const response = await fetch(`/batches/${batchId}/download`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/static/index.html';
                        return;
                    }
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to download batch');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${batchName.replace(/[^a-zA-Z0-9-_]/g, '_')}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                toast.success('Batch downloaded successfully');
                loadBatches();
            } catch (error) {
                console.error('Download error:', error);
                toast.error(error.message || 'Failed to download batch');
            }
        }

        async function handleUpload(event) {
            event.preventDefault();

            const batchName = document.getElementById('batchName').value.trim();
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            const uploadButton = document.getElementById('uploadButton');
            const errorDiv = document.getElementById('uploadError');

            if (!file) {
                errorDiv.textContent = 'Please select a CSV file';
                errorDiv.classList.remove('hidden');
                return;
            }

            uploadButton.disabled = true;
            uploadButton.classList.add('btn-loading');
            errorDiv.classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('name', batchName);
                formData.append('file', file);

                const response = await fetch('/batches', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const batch = await response.json();
                toast.success(`Batch "${batch.name}" uploaded successfully!`);
                uploadModal.hide();
                document.getElementById('uploadForm').reset();
                setTimeout(() => {
                    window.location.href = `/static/categorize.html?batch=${batch.id}`;
                }, 500);
            } catch (error) {
                console.error('Upload error:', error);
                errorDiv.textContent = error.message || 'Failed to upload CSV. Please try again.';
                errorDiv.classList.remove('hidden');
                uploadButton.disabled = false;
                uploadButton.classList.remove('btn-loading');
            }
        }

        async function logout() {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = '/static/index.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
