<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Money Fest - Rules</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#667eea',
                            600: '#764ba2'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-gradient:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl p-4 mb-4 shadow-lg flex flex-wrap justify-between items-center gap-3">
            <h1 class="text-xl font-bold text-gray-800">Categorization Rules</h1>
            <div class="flex gap-2">
                <button onclick="goBack()" class="px-3 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                    ← Back
                </button>
                <button data-modal-target="ruleModal" data-modal-toggle="ruleModal" onclick="showCreateRuleModal()" class="px-4 py-2 text-sm font-semibold text-white btn-gradient rounded-lg transition-all">
                    + Create Rule
                </button>
            </div>
        </div>

        <!-- Rules List -->
        <div id="rulesList" class="space-y-2">
            <p class="text-white text-center py-8">Loading rules...</p>
        </div>
    </div>

    <!-- Create/Edit Rule Modal -->
    <div id="ruleModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-lg max-h-full">
            <div class="relative bg-white rounded-xl shadow-xl">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <h3 id="ruleModalTitle" class="text-lg font-semibold text-gray-800">Create Rule</h3>
                    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-100 hover:text-gray-700 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="ruleModal">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <!-- Modal Body -->
                <form id="ruleForm" onsubmit="saveRule(event)" class="p-4 space-y-4">
                    <div>
                        <label for="rulePattern" class="block text-sm font-semibold text-gray-700 mb-1">Pattern</label>
                        <input type="text" id="rulePattern" required placeholder="e.g., Starbucks"
                               class="w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:outline-none focus:border-brand-500 transition-colors">
                        <p class="text-xs text-gray-400 mt-1">Text to match in transaction payee</p>
                    </div>

                    <div>
                        <label for="ruleMatchType" class="block text-sm font-semibold text-gray-700 mb-1">Match Type</label>
                        <select id="ruleMatchType" required class="w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:outline-none focus:border-brand-500 transition-colors bg-white">
                            <option value="contains">Contains</option>
                            <option value="exact">Exact match</option>
                        </select>
                    </div>

                    <div>
                        <label for="ruleCategory" class="block text-sm font-semibold text-gray-700 mb-1">Category</label>
                        <select id="ruleCategory" required class="w-full px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:outline-none focus:border-brand-500 transition-colors bg-white">
                            <option value="">Select a category...</option>
                        </select>
                    </div>

                    <!-- Preview Section -->
                    <div class="pt-4 border-t border-gray-100">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Matching Transactions <span id="previewCount" class="text-brand-500 font-normal"></span></h4>
                        <div id="previewList" class="max-h-40 overflow-y-auto border border-gray-100 rounded-lg p-2 text-sm">
                            <p class="text-gray-400 italic p-2">Enter a pattern to see matching transactions</p>
                        </div>
                    </div>

                    <div id="ruleError" class="hidden p-3 bg-red-50 text-red-600 border border-red-200 rounded-lg text-sm"></div>

                    <div class="flex gap-2 justify-end pt-2">
                        <button type="button" data-modal-hide="ruleModal" class="px-4 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                            Cancel
                        </button>
                        <button type="submit" id="saveRuleButton" class="px-4 py-2 text-sm font-semibold text-white btn-gradient rounded-lg transition-all">
                            Create Rule
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/toast.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>
    <script>
        let categories = [];
        let rules = [];
        let editingRuleId = null;
        let ruleModal = null;

        window.addEventListener('DOMContentLoaded', () => {
            const $targetEl = document.getElementById('ruleModal');
            ruleModal = new Modal($targetEl);
            loadCategories();
            loadRules();
        });

        async function loadCategories() {
            try {
                const response = await fetch('/categories');
                if (!response.ok) throw new Error('Failed to load categories');

                categories = await response.json();

                const select = document.getElementById('ruleCategory');
                select.innerHTML = '<option value="">Select a category...</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.full_path;
                    option.textContent = category.full_path;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                toast.error('Failed to load categories');
            }
        }

        async function loadRules() {
            try {
                const response = await fetch('/rules');
                if (!response.ok) throw new Error('Failed to load rules');

                rules = await response.json();
                renderRules();
            } catch (error) {
                console.error('Error loading rules:', error);
                document.getElementById('rulesList').innerHTML = '<p class="text-red-200 text-center py-8">Failed to load rules</p>';
            }
        }

        function renderRules() {
            const rulesList = document.getElementById('rulesList');

            if (rules.length === 0) {
                rulesList.innerHTML = `
                    <div class="bg-white rounded-xl p-8 text-center shadow-lg">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">No rules yet</h2>
                        <p class="text-gray-500 text-sm mb-4">Create rules to get smart category suggestions when categorizing transactions</p>
                        <button onclick="showCreateRuleModal()" class="px-4 py-2 text-sm font-semibold text-white btn-gradient rounded-lg transition-all">
                            + Create First Rule
                        </button>
                    </div>
                `;
                return;
            }

            rulesList.innerHTML = rules.map(rule => `
                <div class="bg-white rounded-lg p-3 shadow flex justify-between items-center gap-3">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold text-gray-800 truncate">${escapeHtml(rule.pattern)}</span>
                            <span class="px-2 py-0.5 text-xs font-medium bg-brand-500 text-white rounded">${rule.match_type}</span>
                        </div>
                        <div class="text-sm text-gray-500 truncate">→ ${escapeHtml(rule.category)}</div>
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="editRule(${rule.id})" class="px-2.5 py-1.5 text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                            Edit
                        </button>
                        <button onclick="deleteRule(${rule.id})" class="px-2.5 py-1.5 text-xs font-medium bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showCreateRuleModal() {
            editingRuleId = null;
            document.getElementById('ruleModalTitle').textContent = 'Create Rule';
            document.getElementById('saveRuleButton').textContent = 'Create Rule';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleError').classList.add('hidden');
            document.getElementById('previewList').innerHTML = '<p class="text-gray-400 italic p-2">Enter a pattern to see matching transactions</p>';
            document.getElementById('previewCount').textContent = '';
            ruleModal.show();
        }

        async function editRule(ruleId) {
            const rule = rules.find(r => r.id === ruleId);
            if (!rule) return;

            editingRuleId = ruleId;
            document.getElementById('ruleModalTitle').textContent = 'Edit Rule';
            document.getElementById('saveRuleButton').textContent = 'Update Rule';
            document.getElementById('rulePattern').value = rule.pattern;
            document.getElementById('ruleMatchType').value = rule.match_type;
            document.getElementById('ruleCategory').value = rule.category;
            document.getElementById('ruleError').classList.add('hidden');

            await updatePreview();
            ruleModal.show();
        }

        async function saveRule(event) {
            event.preventDefault();

            const pattern = document.getElementById('rulePattern').value.trim();
            const matchType = document.getElementById('ruleMatchType').value;
            const category = document.getElementById('ruleCategory').value;
            const errorDiv = document.getElementById('ruleError');
            const saveButton = document.getElementById('saveRuleButton');

            if (!pattern || !matchType || !category) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (!editingRuleId) {
                const duplicate = rules.find(r =>
                    r.pattern.toLowerCase() === pattern.toLowerCase() &&
                    r.match_type === matchType &&
                    r.category === category
                );

                if (duplicate) {
                    errorDiv.textContent = 'This rule already exists';
                    errorDiv.classList.remove('hidden');
                    return;
                }
            }

            saveButton.disabled = true;

            try {
                const url = editingRuleId ? `/rules/${editingRuleId}` : '/rules';
                const method = editingRuleId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pattern, match_type: matchType, category })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save rule');
                }

                toast.success(editingRuleId ? 'Rule updated successfully' : 'Rule created successfully');
                ruleModal.hide();
                await loadRules();
            } catch (error) {
                console.error('Error saving rule:', error);
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            } finally {
                saveButton.disabled = false;
            }
        }

        async function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this rule?')) return;

            try {
                const response = await fetch(`/rules/${ruleId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete rule');

                toast.success('Rule deleted successfully');
                await loadRules();
            } catch (error) {
                console.error('Error deleting rule:', error);
                toast.error('Failed to delete rule');
            }
        }

        async function updatePreview() {
            const pattern = document.getElementById('rulePattern').value.trim();
            const matchType = document.getElementById('ruleMatchType').value;
            const previewList = document.getElementById('previewList');
            const previewCount = document.getElementById('previewCount');

            if (!pattern) {
                previewList.innerHTML = '<p class="text-gray-400 italic p-2">Enter a pattern to see matching transactions</p>';
                previewCount.textContent = '';
                return;
            }

            try {
                const response = await fetch('/rules/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pattern, match_type: matchType })
                });

                if (!response.ok) throw new Error('Failed to preview');

                const transactions = await response.json();

                if (transactions.length === 0) {
                    previewList.innerHTML = '<p class="text-gray-400 italic p-2">No matching transactions found</p>';
                    previewCount.textContent = '';
                } else {
                    previewCount.textContent = `(${transactions.length})`;
                    previewList.innerHTML = transactions.slice(0, 10).map(t => {
                        const amount = parseFloat(t.amount);
                        const color = amount >= 0 ? 'text-green-600' : 'text-red-600';
                        const sign = amount >= 0 ? '+' : '';
                        return `
                            <div class="flex justify-between py-1.5 border-b border-gray-50 last:border-0">
                                <span class="truncate">${escapeHtml(t.payee)}</span>
                                <span class="${color} font-medium">${sign}${amount.toFixed(2)}</span>
                            </div>
                        `;
                    }).join('') + (transactions.length > 10 ? `<p class="text-gray-400 italic p-2 text-center">...and ${transactions.length - 10} more</p>` : '');
                }
            } catch (error) {
                console.error('Error previewing:', error);
                previewList.innerHTML = '<p class="text-red-500 p-2">Failed to load preview</p>';
            }
        }

        const debouncedPreview = debounce(updatePreview, 500);

        document.getElementById('rulePattern').addEventListener('input', debouncedPreview);
        document.getElementById('ruleMatchType').addEventListener('change', updatePreview);

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function goBack() {
            window.location.href = '/static/batches.html';
        }
    </script>
</body>
</html>
